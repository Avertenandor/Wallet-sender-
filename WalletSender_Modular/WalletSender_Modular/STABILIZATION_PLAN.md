# WalletSender Modular – План стабилизации (адаптированный)

Версия плана: 2025-09-10
Цель: поэтапно привести приложение к надежному продакшен состоянию с минимальным риском поломок. Каждый этап завершаетcя контрольной проверкой и фиксацией отчета.

## Этап 0. Фиксация состояния

- [ ] Создать резервный бэкап (архив кода + БД).
- [ ] Зафиксировать текущие ключевые метрики вручную: наличие ошибок nonce, средний gas (лог), задержка отправки транзакции.
- [ ] Проверить, что README соответствует версии.

## Этап 1. Унификация nonce

Задачи:

- [x] В auto_sales_tab перейти на NonceManager (как сделано в auto_buy_tab).
- [ ] В direct_send_tab и mass_distribution_tab убедиться, что нет локальных обходов (проверка запланирована).
- [x] В transaction_service добавить опциональную интеграцию с NonceManager (методы send_native, send_token).
- [x] Добавить fail(ticket) на любой необработанный exception до отправки/отправки (обработано в TransactionService и auto_sales_tab fallback).

Контроль:

- [ ] Локальный тест: 10 последовательных транзакций (mock / тестовая сеть) без "nonce too low" (ожидает подготовку mock окружения).

## Этап 2. Централизация swap/approve логики

Задачи:

- [x] Создать сервис (dex_swap_service.py) с approve(), swap_exact_tokens_for_eth(), swap_exact_tokens_for_tokens() (+ wait_receipt).
- [x] Перенести код сборки транзакций из auto_buy_tab (частично: BNB->token пока fallback) и auto_sales_tab (swap через сервис с fallback).
- [x] Добавить метод swap_exact_eth_for_tokens() в сервис (устранён fallback в auto_buy_tab).
- [ ] Внедрить единый путь логирования (пока частично – сервис логирует, вкладки добавляют свои строки).

Контроль:

- [ ] UI: автопокупка и автопродажа вызывают сервис, в самих вкладках только подготовка параметров (осталось вынести остатки build_transaction для USDT->Token и унифицировать логирование).

## Этап 3. Газ и retry

Задачи:

- [ ] Использование GasManager во всех путях (approve, swap, transfers, mass send).
- [ ] Ввести стратегию retry (до 2 попыток):
  - nonce too low → resync (reset + повторный reserve).
  - replacement underpriced → повышаем gas через adjust_gas_for_retry.
  - сетевые timeout → обратноff 1s/2s.
- [ ] Минимальный gas fallback = DEFAULT_GAS_PRICE (5 Gwei); предупреждение если user < 1.

Контроль:

- [ ] Интеграционный тест: имитация ошибки nonce → успешный повтор.

## Этап 4. Очистка дублирования и кэши
Задачи:
- [ ] Удалить локальные `_local_nonce` если больше не используются.
- [ ] Централизовать ABI (Router ABI вынести в constants или abi_store.py).
- [ ] Добавить кэш decimals/ symbol в token_service с простым dict.
Контроль:
- [ ] Поиск по проекту показывает единственный источник для Router ABI.

## Этап 5. Логирование и метрики
Задачи:
- [ ] Единый формат логов + параллельная запись структурированных событий в logs/structured.log (JSON).
- [ ] Метрики: файл metrics.json (txn_sent, txn_failed, nonce_retries, avg_gas_price_gwei).
- [ ] Обработчик глобальных исключений в UI слоях (сигнал → запись в errors.log).
Контроль:
- [ ] metrics.json обновляется после серии транзакций.

## Этап 6. Тестовое покрытие (базовое)
Задачи:
- [ ] Unit: NonceManager (reserve/confirm/fail/expire).
- [ ] Unit: GasManager (fallback, adjust_gas_for_retry).
- [ ] Unit: Dex swap сервис (mock web3, проверка последовательности approve→swap).
- [ ] Integration: последовательная отправка 5 транзакций swap.
Контроль:
- [ ] Все тесты PASS локально.

## Этап 7. Улучшения UX
Задачи:
- [ ] Вкладки auto_*: переключатель Gas Mode (Auto/Manual) + селектор приоритетов (slow/standard/fast/instant).
- [ ] Индикатор состояния NonceManager (цвет/статус) рядом с кнопкой отправки.
- [ ] Предупреждение при gas < 1 Gwei.
Контроль:
- [ ] Визуально подтверждено, взаимодействие не ломает поток.

## Этап 8. Безопасность
Задачи:
- [ ] Проверить отсутствие логирования приватных ключей/seed.
- [ ] (Опционально) Добавить шифрование приватного ключа (пароль → PBKDF2 + AES-GCM) – feature flag.
- [ ] Ввод адресов: checksum нормализация и валидация до отправки.
Контроль:
- [ ] Ручной аудит логов и кода.

## Этап 9. Документация
Задачи:
- [ ] Обновить README (раздел архитектуры + Nonce/Gas).
- [ ] Добавить TESTING.md (как запускать тесты и сценарии).
- [ ] Обновить CHANGELOG (v2.3.x roadmap → факты).
- [ ] SECURITY.md (минимальные практики).
Контроль:
- [ ] Все файлы присутствуют, ссылки валидны.

## Этап 10. Финал перед боевыми тестами
Задачи:
- [ ] Smoke run приложения (запуск/закрытие) – без исключений.
- [ ] Локальный mock тест 10 swaps подряд.
- [ ] Сбор финального отчета REPORT_GENESIS.md (краткая сводка по этапам + метрики).
- [ ] Подготовить инструкцию для боевого теста (шаги подключения кошелька и проверки).
Контроль:
- [ ] Отчет создан, критерии пройдены.

## Отложенные/Опциональные задачи
- Наблюдаемость через Prometheus exporter.
- GUI вкладка диагностики (nonce/gas/live metrics).
- PyInstaller дистрибутив.

## Риски
- Несогласованное состояние NonceManager при крахе → смягчено fail в finally.
- Повышение газа может привести к переплате → лимитируем рост до +50%.

## Метрики успеха (к проверке с боевыми данными)
- 0 ошибок nonce за 20 последовательных транзакций.
- <2% failed swaps (без учета реальных revert контрактов).
- Средний лаг отправки (кнопка → tx hash) < 500ms локально.
- Все тесты PASS.

---
Дальнейшие шаги: начать с Этапа 0 (бэкап), затем последовательно. Боевые тесты запускаются после завершения Этапа 10.
